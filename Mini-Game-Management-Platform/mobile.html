<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GameHub Mobile</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¦æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ */
        body { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; background-color: #1a202c; color: white; }
        .game-iframe { width: 100%; height: 100%; border: none; }
        
        /* è™šæ‹Ÿæ‰‹æŸ„æ ·å¼ */
        .dpad-btn {
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; touch-action: manipulation;
            transition: background 0.1s;
        }
        .dpad-btn:active, .dpad-btn.active { background: rgba(255, 255, 255, 0.5); }
        
        .action-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            font-weight: bold; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            touch-action: manipulation;
        }
        .btn-a { background: #48bb78; border: 2px solid #2f855a; } /* Green */
        .btn-b { background: #f56565; border: 2px solid #c53030; } /* Red */
        .btn-a:active { background: #38a169; transform: scale(0.95); }
        .btn-b:active { background: #e53e3e; transform: scale(0.95); }

        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex flex-col h-full">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="flex justify-between items-center p-3 bg-gray-800 shadow-md z-10">
            <div class="text-xl font-bold text-blue-500">ğŸ® Hub</div>
            <div class="flex items-center space-x-2">
                <div v-if="!user">
                    <button @click="showLogin=true" class="bg-blue-600 px-3 py-1 rounded text-sm">ç™»å½•/æ³¨å†Œ</button>
                </div>
                <div v-else class="flex items-center space-x-2">
                    <img :src="user.avatar" class="w-8 h-8 rounded-full border border-gray-500 bg-gray-700 object-cover" @click="openProfile">
                </div>
            </div>
        </nav>

        <!-- æ¸¸æˆåˆ—è¡¨åŒºåŸŸ -->
        <div class="flex-grow overflow-y-auto p-4 space-y-4 pb-20">
            <div v-for="game in games" :key="game.id" class="bg-gray-800 rounded-xl p-4 flex items-center space-x-4 shadow-lg border border-gray-700" @click="openGame(game)">
                <div class="text-4xl bg-gray-700 rounded-lg p-2">{{ game.icon }}</div>
                <div class="flex-grow">
                    <h3 class="font-bold text-lg">{{ game.name }}</h3>
                    <p class="text-gray-400 text-xs line-clamp-1">{{ game.desc }}</p>
                </div>
                <button class="bg-blue-600 px-3 py-1.5 rounded-lg text-sm font-bold shadow">ç©</button>
            </div>
        </div>

        <!-- ç™»å½•å¼¹çª— -->
        <div v-if="showLogin" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-6">
            <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-sm border border-gray-600">
                <h2 class="text-2xl font-bold mb-4">ç™»å½• / æ³¨å†Œ</h2>
                <input v-model="auth.username" placeholder="ç”¨æˆ·å" class="w-full bg-gray-700 p-3 rounded-lg mb-3 text-white border border-gray-600">
                <input v-model="auth.password" type="password" placeholder="å¯†ç " class="w-full bg-gray-700 p-3 rounded-lg mb-6 text-white border border-gray-600">
                <div class="flex gap-4">
                    <button @click="handleAuth('login')" class="flex-1 bg-blue-600 py-3 rounded-lg font-bold">ç™»å½•</button>
                    <button @click="handleAuth('register')" class="flex-1 bg-green-600 py-3 rounded-lg font-bold">æ³¨å†Œ</button>
                </div>
                <button @click="showLogin=false" class="w-full mt-4 text-gray-400 text-sm">æš‚ä¸ç™»å½•</button>
            </div>
        </div>

        <!-- ä¸ªäººä¸­å¿ƒå¼¹çª— -->
        <div v-if="showProfile" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-6">
            <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-sm border border-gray-600 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">ä¸ªäººä¸­å¿ƒ</h2>
                    <button @click="showProfile=false" class="text-gray-400 text-2xl">&times;</button>
                </div>
                
                <div class="flex flex-col items-center mb-6">
                    <div class="relative w-24 h-24 mb-3">
                        <img :src="user.avatar" class="w-full h-full rounded-full border-4 border-gray-600 object-cover">
                        <input type="file" @change="uploadAvatar" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <div class="text-xl font-bold">{{ user.username }}</div>
                    <button @click="logout" class="text-red-400 text-sm mt-2">é€€å‡ºç™»å½•</button>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <h3 class="text-gray-400 text-xs font-bold uppercase mb-3">å†å²æœ€ä½³</h3>
                    <div class="space-y-2">
                        <div v-for="stat in userStats" :key="stat.game_key" class="flex justify-between bg-gray-700/50 p-2 rounded">
                            <span>{{ stat.game_name }}</span>
                            <span class="font-mono text-blue-400 font-bold">{{ stat.best_score }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨å±æ¸¸æˆå®¹å™¨ -->
        <div v-if="currentGame" class="fixed inset-0 bg-black z-40 flex flex-col">
            <!-- é¡¶éƒ¨æ  -->
            <div class="h-12 bg-gray-900 flex justify-between items-center px-4 border-b border-gray-800">
                <span class="font-bold text-gray-300">{{ currentGame.name }}</span>
                <button @click="closeGame" class="text-red-500 font-bold border border-red-500 px-3 py-0.5 rounded text-sm">é€€å‡º</button>
            </div>

            <!-- æ¸¸æˆåŒºåŸŸ (è‡ªé€‚åº”å‰©ä½™ç©ºé—´) -->
            <div class="flex-grow relative bg-black flex items-center justify-center overflow-hidden">
                <iframe ref="gameIframe" :src="getGameUrl(currentGame)" class="game-iframe" scrolling="no"></iframe>
            </div>

            <!-- è™šæ‹Ÿæ§åˆ¶å™¨ (åº•éƒ¨) -->
            <!-- åªæœ‰éè§¦å±æ¸¸æˆæ‰æ˜¾ç¤ºæ§åˆ¶å™¨ -->
            <div v-if="needsController(currentGame.id)" class="h-48 bg-gray-900 border-t border-gray-700 relative flex-shrink-0">
                <!-- D-Pad (Left) -->
                <div class="absolute left-6 top-1/2 transform -translate-y-1/2 w-40 h-40">
                    <div class="relative w-full h-full">
                        <div @touchstart.prevent="pressKey('ArrowUp')" @touchend.prevent="releaseKey('ArrowUp')" class="dpad-btn absolute top-0 left-1/2 transform -translate-x-1/2">â¬†ï¸</div>
                        <div @touchstart.prevent="pressKey('ArrowDown')" @touchend.prevent="releaseKey('ArrowDown')" class="dpad-btn absolute bottom-0 left-1/2 transform -translate-x-1/2">â¬‡ï¸</div>
                        <div @touchstart.prevent="pressKey('ArrowLeft')" @touchend.prevent="releaseKey('ArrowLeft')" class="dpad-btn absolute left-0 top-1/2 transform -translate-y-1/2">â¬…ï¸</div>
                        <div @touchstart.prevent="pressKey('ArrowRight')" @touchend.prevent="releaseKey('ArrowRight')" class="dpad-btn absolute right-0 top-1/2 transform -translate-y-1/2">â¡ï¸</div>
                    </div>
                </div>

                <!-- Action Buttons (Right) -->
                <div class="absolute right-8 top-1/2 transform -translate-y-1/2 flex gap-4">
                    <!-- B Button (Cancel/Rotate2) -->
                    <div @touchstart.prevent="pressKey(btnBKey)" @touchend.prevent="releaseKey(btnBKey)" class="action-btn btn-b mt-8">B</div>
                    <!-- A Button (Confirm/Fire/Jump) -->
                    <div @touchstart.prevent="pressKey(btnAKey)" @touchend.prevent="releaseKey(btnAKey)" class="action-btn btn-a -mt-4">A</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        createApp({
            setup() {
                const user = ref(JSON.parse(localStorage.getItem('user')));
                const games = ref([]);
                const showLogin = ref(false);
                const showProfile = ref(false);
                const auth = ref({username: '', password: ''});
                const userStats = ref([]);
                
                const currentGame = ref(null);
                const gameIframe = ref(null);

                // å®šä¹‰å“ªäº›æ¸¸æˆéœ€è¦è™šæ‹Ÿæ‰‹æŸ„ï¼Œä»¥åŠå¯¹åº”çš„ A/B é”®æ˜ å°„
                const controllerConfig = {
                    'tetris':   { needs: true,  a: 'w', b: 'q' }, // W=Rotate, Q=RotateBack
                    'snake':    { needs: true,  a: ' ', b: ' ' }, // Snake only needs arrows usually
                    'tank':     { needs: true,  a: 'Space', b: 'Space' }, // Space fire
                    'raiden':   { needs: true,  a: 'Space', b: 'Space' }, // Space fire
                    'breakout': { needs: true,  a: ' ', b: ' ' },
                    'pong':     { needs: true,  a: ' ', b: ' ' }, // Mouse usually, but we might need keys
                    '2048':     { needs: true,  a: ' ', b: ' ' },
                    'maze':     { needs: true,  a: ' ', b: ' ' },
                    // Touch games (no controller needed)
                    'flappy':   { needs: false },
                    'mole':     { needs: false },
                    'gomoku':   { needs: false },
                    'poker':    { needs: false }
                };

                const needsController = (id) => controllerConfig[id]?.needs || false;
                
                // è®¡ç®—å½“å‰æ¸¸æˆçš„ A/B é”®å¯¹åº”çš„ KeyCode
                const btnAKey = computed(() => currentGame.value ? (controllerConfig[currentGame.value.id]?.a || 'Space') : 'Space');
                const btnBKey = computed(() => currentGame.value ? (controllerConfig[currentGame.value.id]?.b || 'Escape') : 'Escape');

                // æ¨¡æ‹ŸæŒ‰é”®äº‹ä»¶å‘é€ç»™ iframe
                const triggerEvent = (type, key) => {
                    if(!gameIframe.value || !gameIframe.value.contentWindow) return;
                    
                    // æ˜ å°„ 'w', 'q', 'Space' ç­‰åˆ°æ ‡å‡† code
                    let code = key;
                    if(key === 'w') code = 'KeyW';
                    if(key === 'q') code = 'KeyQ';
                    
                    // æ„é€  KeyboardEvent
                    const ev = new KeyboardEvent(type, {
                        key: key,
                        code: code,
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    gameIframe.value.contentWindow.dispatchEvent(ev);
                };

                const pressKey = (key) => triggerEvent('keydown', key);
                const releaseKey = (key) => triggerEvent('keyup', key);

                // --- Auth ---
                const handleAuth = async (type) => {
                    if (!auth.value.username || !auth.value.password) return alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
                    try {
                        const res = await fetch(`/api/${type}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(auth.value)
                        });
                        const data = await res.json();
                        if(res.ok) {
                            if(type === 'login') {
                                user.value = data;
                                localStorage.setItem('user', JSON.stringify(data));
                                showLogin.value = false;
                            } else {
                                alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                                auth.value.password = ''; 
                            }
                        } else alert(data.detail || "æ“ä½œå¤±è´¥");
                    } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
                };

                const logout = () => { user.value = null; localStorage.removeItem('user'); showProfile.value = false; };

                // --- Game Logic ---
                const openGame = (game) => {
                    if (!user.value) { showLogin.value = true; return; }
                    currentGame.value = game;
                };

                const closeGame = () => {
                    // ç§»åŠ¨ç«¯ç®€åŒ–ï¼šç›´æ¥é€šçŸ¥ä¿å­˜å¹¶é€€å‡ºï¼Œæˆ–è€…ç›´æ¥å…³é—­
                    if(gameIframe.value && gameIframe.value.contentWindow) {
                        gameIframe.value.contentWindow.postMessage('submit_and_exit', '*');
                        // ç¨å¾®å»¶è¿Ÿå…³é—­ä»¥å…è®¸å‘é€è¯·æ±‚
                        setTimeout(() => { currentGame.value = null; }, 500);
                    } else {
                        currentGame.value = null;
                    }
                };

                const getGameUrl = (game) => {
                    if (!game || !user.value) return '';
                    const separator = game.url.includes('?') ? '&' : '?';
                    return `${game.url}${separator}uid=${user.value.id}&gkey=${game.id}`;
                };

                // --- Profile ---
                const openProfile = async () => {
                    showProfile.value = true;
                    try {
                        const res = await fetch(`/api/user/stats/${user.value.id}`);
                        userStats.value = await res.json();
                    } catch (e) {}
                };

                const uploadAvatar = async (event) => {
                    const file = event.target.files[0];
                    if(!file) return;
                    const formData = new FormData();
                    formData.append('user_id', user.value.id);
                    formData.append('file', file);
                    try {
                        const res = await fetch('/api/user/avatar', { method: 'POST', body: formData });
                        const data = await res.json();
                        if(res.ok) {
                            user.value.avatar = data.avatar_url;
                            localStorage.setItem('user', JSON.stringify(user.value));
                        }
                    } catch (e) {}
                };

                onMounted(async () => {
                    try {
                        const res = await fetch('/api/games');
                        games.value = await res.json();
                    } catch (e) {}
                });

                return {
                    user, games, showLogin, showProfile, auth, userStats,
                    currentGame, gameIframe,
                    handleAuth, logout, openGame, closeGame, getGameUrl, 
                    openProfile, uploadAvatar,
                    needsController, pressKey, releaseKey, btnAKey, btnBKey
                }
            }
        }).mount('#app')
    </script>
</body>
</html>