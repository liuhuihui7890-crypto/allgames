<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç»å…¸è´ªåƒè›‡ - MiniGame HUB</title>
    <style>
        body { background: #1a202c; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        canvas { border: 4px solid #2d3748; background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 8px; }
        .info { margin-bottom: 20px; text-align: center; }
        #score { font-size: 24px; color: #4299e1; font-weight: bold; }
        /* æ¸¸æˆç»“æŸå¼¹çª— */
        #submitUI { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2d3748; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 2px solid #4299e1; z-index: 100; }
        input { padding: 10px; border-radius: 5px; border: none; margin: 10px 0; width: 200px; text-align: center; }
        button { padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #3182ce; }
    </style>
</head>
<body>

    <div class="info">
        <h1>ğŸ ç»å…¸è´ªåƒè›‡</h1>
        <div>å¾—åˆ†: <span id="score">0</span></div>
        <p style="color: #a0aec0; font-size: 14px;">ä½¿ç”¨æ–¹å‘é”®æ§åˆ¶ç§»åŠ¨</p>
    </div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>

    <div id="submitUI">
        <h2 style="margin-top:0">æ¸¸æˆç»“æŸ!</h2>
        <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
        <input type="text" id="playerName" placeholder="è¾“å…¥ä½ çš„å¤§å" maxlength="10"><br>
        <button onclick="uploadScore()">æäº¤åˆ†æ•°å¹¶è¿”å›å¤§å…</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');

        let score = 0;
        let gridSize = 20;
        let tileCount = 20;
        let snake = [{x: 10, y: 10}];
        let food = {x: 15, y: 15};
        let dx = 0;
        let dy = 0;
        let gameActive = true;

        function drawGame() {
            if (!gameActive) return;

            updateSnake();
            if (checkGameOver()) return;

            // æ¸…å±
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç”»é£Ÿç‰©
            ctx.fillStyle = '#f56565';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);

            // ç”»è›‡
            ctx.fillStyle = '#48bb78';
            snake.forEach((part, index) => {
                if (index === 0) ctx.fillStyle = '#38a169'; // è›‡å¤´é¢œè‰²æ·±ä¸€ç‚¹
                else ctx.fillStyle = '#48bb78';
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize - 2, gridSize - 2);
            });

            setTimeout(drawGame, 100);
        }

        function updateSnake() {
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};

            // å¦‚æœæ²¡åŠ¨ï¼ˆåˆšå¼€å§‹ï¼‰ï¼Œä¸æ›´æ–°
            if (dx === 0 && dy === 0) return;

            snake.unshift(head);

            // åƒé£Ÿç‰©æ£€æŸ¥
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreElement.innerText = score;
                createFood();
            } else {
                snake.pop();
            }
        }

        function createFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            // ç¡®ä¿é£Ÿç‰©ä¸åœ¨è›‡èº«ä¸Š
            if (snake.some(part => part.x === food.x && part.y === food.y)) createFood();
        }

        function checkGameOver() {
            if (dx === 0 && dy === 0) return false;

            const head = snake[0];
            // æ’å¢™
            const hitWall = head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount;
            // å’¬åˆ°è‡ªå·±
            const hitSelf = snake.slice(1).some(part => part.x === head.x && part.y === head.y);

            if (hitWall || hitSelf) {
                gameActive = false;
                showSubmitUI();
                return true;
            }
            return false;
        }

        function showSubmitUI() {
            document.getElementById('finalScore').innerText = score;
            document.getElementById('submitUI').style.display = 'block';
        }

        async function uploadScore() {
            const name = document.getElementById('playerName').value || "æ— åè‹±é›„";
            try {
                await fetch('/api/scores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        game_key: "snake",
                        player_name: name,
                        score: score
                    })
                });
                window.location.href = '/'; // æäº¤åè¿”å›å¤§å…
            } catch (err) {
                console.error("æäº¤å¤±è´¥", err);
                window.location.href = '/';
            }
        }

        window.addEventListener('keydown', e => {
            switch(e.key) {
                case 'ArrowUp': if (dy !== 1) { dx = 0; dy = -1; } break;
                case 'ArrowDown': if (dy !== -1) { dx = 0; dy = 1; } break;
                case 'ArrowLeft': if (dx !== 1) { dx = -1; dy = 0; } break;
                case 'ArrowRight': if (dx !== -1) { dx = 1; dy = 0; } break;
            }
        });

        drawGame();
    </script>
</body>
</html>