<!DOCTYPE html>
<html>
<head>
    <title>Blackjack</title>
    <style>
        body { background: #004400; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { width: 60px; height: 90px; background: #fff; border-radius: 5px; color: #000; display: inline-flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; margin: 5px; border: 1px solid #ccc; }
        .red { color: red; }
        .black { color: black; }
        #board { margin-top: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        #msg { height: 30px; margin: 10px; color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Blackjack</h1>
    <div id="msg"></div>
    <div>Score (Chips): <span id="chips">100</span></div>
    
    <div id="board">
        <div>Dealer: <span id="d-score"></span></div>
        <div id="dealer-cards"></div>
        <br>
        <div>Player: <span id="p-score"></span></div>
        <div id="player-cards"></div>
    </div>

    <div id="controls">
        <button onclick="hit()">Hit</button>
        <button onclick="stand()">Stand</button>
        <button onclick="newGame()">New Hand</button>
    </div>

    <script>
        const suits = ['♠', '♥', '♦', '♣'];
        const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        let deck = [];
        let dealerHand = [], playerHand = [];
        let chips = 100;
        let gameOver = true;

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        const gameKey = urlParams.get('gkey') || 'poker';

        window.addEventListener('message', async function(e) {
            if(e.data === 'submit_and_exit') {
                await submitScore();
                window.parent.postMessage('score_submitted', '*');
            }
        });

        function createDeck() {
            deck = [];
            for (let s of suits) {
                for (let v of values) {
                    deck.push({ suit: s, value: v, color: (s === '♥' || s === '♦') ? 'red' : 'black' });
                }
            }
            deck.sort(() => Math.random() - 0.5);
        }

        function getCardValue(card) {
            if (['J','Q','K'].includes(card.value)) return 10;
            if (card.value === 'A') return 11;
            return parseInt(card.value);
        }

        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            for (let c of hand) {
                score += getCardValue(c);
                if (c.value === 'A') aces++;
            }
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }

        function renderCard(card, targetId) {
            const div = document.createElement('div');
            div.className = `card ${card.color}`;
            div.innerText = card.value + card.suit;
            document.getElementById(targetId).appendChild(div);
        }

        function updateUI() {
            document.getElementById('dealer-cards').innerHTML = '';
            document.getElementById('player-cards').innerHTML = '';
            
            // Show dealer first card only if game ongoing
            if (!gameOver) {
                renderCard(dealerHand[0], 'dealer-cards');
                const hidden = document.createElement('div');
                hidden.className = 'card black';
                hidden.style.background = '#888';
                hidden.innerText = '?';
                document.getElementById('dealer-cards').appendChild(hidden);
                document.getElementById('d-score').innerText = '?';
            } else {
                dealerHand.forEach(c => renderCard(c, 'dealer-cards'));
                document.getElementById('d-score').innerText = calculateScore(dealerHand);
            }

            playerHand.forEach(c => renderCard(c, 'player-cards'));
            document.getElementById('p-score').innerText = calculateScore(playerHand);
            document.getElementById('chips').innerText = chips;
        }

        function newGame() {
            if(chips <= 0) { chips = 100; alert("Refilled chips!"); }
            createDeck();
            dealerHand = [deck.pop(), deck.pop()];
            playerHand = [deck.pop(), deck.pop()];
            gameOver = false;
            document.getElementById('msg').innerText = '';
            updateUI();
            
            if (calculateScore(playerHand) === 21) {
                endRound("Blackjack! You win!");
                chips += 15;
            }
        }

        function hit() {
            if (gameOver) return;
            playerHand.push(deck.pop());
            updateUI();
            if (calculateScore(playerHand) > 21) {
                endRound("Bust! You lose.");
                chips -= 10;
            }
        }

        function stand() {
            if (gameOver) return;
            let dScore = calculateScore(dealerHand);
            while (dScore < 17) {
                dealerHand.push(deck.pop());
                dScore = calculateScore(dealerHand);
            }
            gameOver = true;
            updateUI();
            
            const pScore = calculateScore(playerHand);
            if (dScore > 21 || pScore > dScore) {
                document.getElementById('msg').innerText = "You Win!";
                chips += 10;
            } else if (pScore === dScore) {
                document.getElementById('msg').innerText = "Push.";
            } else {
                document.getElementById('msg').innerText = "Dealer Wins.";
                chips -= 10;
            }
            submitScore();
        }

        function endRound(msg) {
            gameOver = true;
            document.getElementById('msg').innerText = msg;
            updateUI();
            submitScore();
        }

        async function submitScore() {
            if(!userId) return;
            try {
                await fetch('/api/scores', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ game_key: gameKey, user_id: parseInt(userId), score: chips })
                });
            } catch(e) {}
        }

        newGame();
    </script>
</body>
</html>