<!DOCTYPE html>
<html>
<head>
    <title>Whac-A-Mole</title>
    <style>
        body { 
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); 
            text-align: center; 
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; 
            color: #333; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewport="0 0 40 40" style="fill:black;font-size:30px;"><text y="50%">ðŸ”¨</text></svg>') 16 0, auto; /* Custom Hammer Cursor */
        }
        
        h1 {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .game-area {
            background: #5d4037;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 5px solid #3e2723;
            position: relative;
        }
        
        /* Grass Decoration */
        .game-area::before {
            content: '';
            position: absolute;
            top: -15px; left: -15px; right: -15px; bottom: -15px;
            border: 5px dashed #4CAF50;
            border-radius: 25px;
            z-index: -1;
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(3, 100px); 
            gap: 20px; 
        }
        
        .hole { 
            width: 100px; height: 100px; 
            background: radial-gradient(circle at 50% 10%, #3e2723 60%, #251613 100%);
            border-radius: 50%; 
            position: relative; 
            overflow: hidden; 
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.8), 0 2px 0 rgba(255,255,255,0.2); 
        }
        
        /* Mole */
        .mole { 
            width: 70px; height: 80px; 
            background: #8d6e63; 
            border-radius: 40% 40% 10% 10%; 
            position: absolute; 
            top: 100px; left: 15px; 
            transition: top 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: auto;
        }
        
        .mole::before { /* Nose */
            content: '';
            position: absolute;
            top: 35px; left: 25px;
            width: 20px; height: 15px;
            background: #3e2723;
            border-radius: 50%;
        }
        
        .mole::after { /* Eyes */
            content: 'ðŸ‘€'; 
            font-size: 30px; 
            position: absolute; 
            top: 5px; left: 20px; 
        }
        
        .mole.up { top: 10px; }
        
        /* Hit Effect */
        .mole.bonked {
            background: #ef5350;
            top: 10px;
            transition: top 0.1s;
        }
        .mole.bonked::after { content: 'ðŸ˜µ'; }

        button { 
            font-size: 20px; 
            padding: 12px 30px; 
            margin-top: 30px; 
            cursor: pointer; 
            border: none; 
            border-radius: 50px; 
            background: linear-gradient(to bottom, #ffca28 0%, #ff6f00 100%); 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Score: <span id="score">0</span> | Time: <span id="time">30</span></h1>
    
    <div class="game-area">
        <div class="grid" id="grid"></div>
    </div>
    
    <button onclick="startGame()" id="startBtn">Start Game</button>

    <script>
        let score = 0;
        let lastHole;
        let timeUp = false;
        let timeLeft = 30;
        const grid = document.getElementById('grid');
        const scoreBoard = document.getElementById('score');
        const timeBoard = document.getElementById('time');
        const holes = [];

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        const gameKey = urlParams.get('gkey') || 'mole';

        window.addEventListener('message', async function(e) {
            if(e.data === 'submit_and_exit') {
                await submitScore();
                window.parent.postMessage('score_submitted', '*');
            }
        });

        // Init Holes
        for(let i=0; i<9; i++) {
            const h = document.createElement('div');
            h.className = 'hole';
            const m = document.createElement('div');
            m.className = 'mole';
            m.onclick = function() { bonk(this); }; // Important: pass 'this'
            h.appendChild(m);
            grid.appendChild(h);
            holes.push(h);
        }

        function randomTime(min, max) { return Math.round(Math.random() * (max - min) + min); }
        function randomHole(holes) {
            const idx = Math.floor(Math.random() * holes.length);
            const hole = holes[idx];
            if (hole === lastHole) return randomHole(holes);
            lastHole = hole;
            return hole;
        }

        function peep() {
            const time = randomTime(400, 1000);
            const hole = randomHole(holes);
            const mole = hole.querySelector('.mole');
            mole.classList.remove('bonked'); // Reset state
            mole.classList.add('up');
            setTimeout(() => {
                mole.classList.remove('up');
                if (!timeUp) peep();
            }, time);
        }

        function startGame() {
            scoreBoard.textContent = 0;
            timeBoard.textContent = 30;
            score = 0;
            timeUp = false;
            timeLeft = 30;
            document.getElementById('startBtn').disabled = true;
            peep();
            const timer = setInterval(() => {
                timeLeft--;
                timeBoard.textContent = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    timeUp = true;
                    document.getElementById('startBtn').disabled = false;
                    submitScore();
                    alert("Time's up! Score: " + score);
                }
            }, 1000);
        }

        function bonk(mole) {
            if(!mole.classList.contains('up')) return;
            score++;
            mole.classList.remove('up'); 
            mole.classList.add('bonked'); // Hit effect
            scoreBoard.textContent = score;
            
            // Re-show mole briefly as bonked? Or just hide immediately. 
            // Current css logic: remove 'up' hides it. Let's keep it simple.
            // If we want to show 'bonked' face, we need to keep it up briefly.
            // Let's modify:
            mole.classList.add('up'); // Keep it visible for a split second
            setTimeout(() => {
                mole.classList.remove('up');
                mole.classList.remove('bonked');
            }, 200);
        }

        async function submitScore() {
            if(!userId) return;
            try {
                await fetch('/api/scores', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ game_key: gameKey, user_id: parseInt(userId), score: score })
                });
            } catch(e) {}
        }
    </script>
</body>
</html>