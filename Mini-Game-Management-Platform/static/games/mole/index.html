<!DOCTYPE html>
<html>
<head>
    <title>Whac-A-Mole</title>
    <style>
        body { background: #5d4037; text-align: center; font-family: 'Comic Sans MS', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(3, 100px); gap: 20px; margin-top: 20px; }
        .hole { width: 100px; height: 100px; background: #3e2723; border-radius: 50%; position: relative; overflow: hidden; border-bottom: 5px solid rgba(255,255,255,0.1); box-shadow: inset 0 10px 10px rgba(0,0,0,0.5); }
        .mole { width: 80px; height: 80px; background: #8d6e63; border-radius: 40%; position: absolute; top: 100px; left: 10px; transition: top 0.2s; cursor: pointer; }
        .mole::after { content: "ðŸ‘€"; font-size: 40px; position: absolute; top: 15px; left: 20px; }
        .mole.up { top: 10px; }
        button { font-size: 20px; padding: 10px 20px; margin-top: 20px; cursor: pointer; border: none; border-radius: 5px; background: #ffca28; color: #3e2723; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Score: <span id="score">0</span> | Time: <span id="time">30</span></h1>
    <div class="grid" id="grid"></div>
    <button onclick="startGame()" id="startBtn">Start Game</button>

    <script>
        let score = 0;
        let lastHole;
        let timeUp = false;
        let timeLeft = 30;
        const grid = document.getElementById('grid');
        const scoreBoard = document.getElementById('score');
        const timeBoard = document.getElementById('time');
        const holes = [];

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        const gameKey = urlParams.get('gkey') || 'mole';

        window.addEventListener('message', async function(e) {
            if(e.data === 'submit_and_exit') {
                await submitScore();
                window.parent.postMessage('score_submitted', '*');
            }
        });

        // Init Holes
        for(let i=0; i<9; i++) {
            const h = document.createElement('div');
            h.className = 'hole';
            const m = document.createElement('div');
            m.className = 'mole';
            m.onclick = function() { bonk(this); };
            h.appendChild(m);
            grid.appendChild(h);
            holes.push(h);
        }

        function randomTime(min, max) { return Math.round(Math.random() * (max - min) + min); }
        function randomHole(holes) {
            const idx = Math.floor(Math.random() * holes.length);
            const hole = holes[idx];
            if (hole === lastHole) return randomHole(holes);
            lastHole = hole;
            return hole;
        }

        function peep() {
            const time = randomTime(400, 1000);
            const hole = randomHole(holes);
            const mole = hole.querySelector('.mole');
            mole.classList.add('up');
            setTimeout(() => {
                mole.classList.remove('up');
                if (!timeUp) peep();
            }, time);
        }

        function startGame() {
            scoreBoard.textContent = 0;
            timeBoard.textContent = 30;
            score = 0;
            timeUp = false;
            timeLeft = 30;
            document.getElementById('startBtn').disabled = true;
            peep();
            const timer = setInterval(() => {
                timeLeft--;
                timeBoard.textContent = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    timeUp = true;
                    document.getElementById('startBtn').disabled = false;
                    submitScore();
                    alert("Time's up! Score: " + score);
                }
            }, 1000);
        }

        function bonk(mole) {
            if(!mole.classList.contains('up')) return;
            score++;
            mole.classList.remove('up');
            scoreBoard.textContent = score;
        }

        async function submitScore() {
            if(!userId) return;
            try {
                await fetch('/api/scores', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ game_key: gameKey, user_id: parseInt(userId), score: score })
                });
            } catch(e) {}
        }
    </script>
</body>
</html>