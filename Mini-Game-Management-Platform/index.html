<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Mini-Game HUB</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .game-iframe { width: 100%; height: 100%; border: none; }
        .ad-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 60; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div id="app" class="container mx-auto px-4 py-8 relative">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="flex justify-between items-center mb-8 p-4 bg-gray-800 rounded-xl shadow-lg">
            <div class="text-2xl font-bold text-blue-500 flex items-center gap-2">
                <span>ğŸ®</span> GameHub
            </div>
            <div class="flex items-center space-x-4">
                <div v-if="!user" class="flex space-x-2">
                    <input v-model="auth.username" placeholder="ç”¨æˆ·å" class="bg-gray-700 text-white px-3 py-1.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    <input v-model="auth.password" type="password" placeholder="å¯†ç " class="bg-gray-700 text-white px-3 py-1.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    <button @click="handleAuth('login')" class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded-lg transition shadow-md">ç™»å½•</button>
                    <button @click="handleAuth('register')" class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg transition shadow-md">æ³¨å†Œ</button>
                </div>
                <div v-else class="flex items-center space-x-4">
                    <button @click="openProfile" class="flex items-center space-x-3 bg-gray-700/50 hover:bg-gray-700 px-3 py-1.5 rounded-full border border-gray-600 transition">
                        <img :src="user.avatar" class="w-8 h-8 rounded-full border border-gray-500 object-cover">
                        <span class="font-medium text-gray-200">{{ user.username }}</span>
                    </button>
                    <button @click="logout" class="text-gray-400 hover:text-red-400 transition font-medium">é€€å‡º</button>
                </div>
            </div>
        </nav>

        <!-- æ¸¸æˆåˆ—è¡¨ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div v-for="game in games" :key="game.id" class="bg-gray-800 rounded-2xl overflow-hidden hover:shadow-2xl hover:shadow-blue-500/20 transition duration-300 border border-gray-700 flex flex-col group">
                <div class="p-6 flex-grow relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110 duration-500">
                         <div class="text-9xl">{{ game.icon }}</div>
                    </div>
                    <div class="flex items-center justify-between mb-4 relative z-10">
                        <div class="text-5xl bg-gray-700/30 p-3 rounded-2xl shadow-inner">{{ game.icon }}</div>
                    </div>
                    <h3 class="text-2xl font-bold mb-2 relative z-10">{{ game.name }}</h3>
                    <p class="text-gray-400 text-sm leading-relaxed mb-6 relative z-10">{{ game.desc }}</p>
                </div>
                <div class="p-6 pt-0 mt-auto grid grid-cols-2 gap-4">
                    <button @click="openGame(game)" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-xl transition shadow-lg transform active:scale-95">
                        â–¶ å¼€å§‹ç©
                    </button>
                    <button @click="fetchLeaderboard(game.id)" class="bg-gray-700 hover:bg-gray-600 text-blue-300 font-bold py-3 rounded-xl transition border border-gray-600 hover:border-blue-400/50">
                        ğŸ† æ’è¡Œæ¦œ
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆæ¨¡æ€æ¡† -->
        <div v-if="currentGame" class="fixed inset-0 bg-black z-50 flex flex-col animate-fade-in">
            <div class="bg-gray-900 p-4 flex justify-between items-center border-b border-gray-800 shadow-md">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">{{ currentGame.icon }}</span>
                    <h2 class="text-xl font-bold text-gray-100">{{ currentGame.name }}</h2>
                </div>
                <!-- é€€å‡ºæ¸¸æˆæŒ‰é’® -->
                <button @click="closeGame" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold transition shadow-lg flex items-center gap-2">
                    <span v-if="isExiting" class="animate-spin">âŒ›</span>
                    <span>{{ isExiting ? 'æ­£åœ¨ä¿å­˜...' : 'âœ• é€€å‡ºæ¸¸æˆ' }}</span>
                </button>
            </div>
            <div class="flex-grow relative bg-gray-900 flex justify-center items-center overflow-hidden">
                <div v-if="showAd" class="ad-overlay">
                    <div class="bg-white text-gray-900 p-10 rounded-3xl max-w-md text-center shadow-2xl transform scale-100 transition-all">
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold mb-1 text-gray-800">ğŸ® æ“ä½œè¯´æ˜</h3>
                            <div class="w-16 h-1 bg-blue-500 mx-auto rounded-full mb-4"></div>
                            <p class="text-xl font-medium text-gray-600 bg-gray-100 py-3 px-6 rounded-lg inline-block shadow-inner">
                                {{ getInstructions(currentGame.id) }}
                            </p>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Advertisement</h4>
                            <div class="p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl mb-6">
                                <div class="text-4xl mb-2">ğŸ§</div>
                                <p class="font-bold text-gray-700">è¶…æ²‰æµ¸æ¸¸æˆè€³æœº</p>
                            </div>
                        </div>

                        <button class="w-full bg-gray-800 text-white font-bold py-3 px-8 rounded-full cursor-not-allowed transition-colors shadow-lg" disabled>
                            æ¸¸æˆåŠ è½½ä¸­... {{ adCountdown }}s
                        </button>
                    </div>
                </div>
                <iframe ref="gameIframe" v-show="!showAd" :src="getGameUrl(currentGame)" class="game-iframe w-full h-full" allow="autoplay; fullscreen" title="Game Window"></iframe>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œå¼¹çª— -->
        <div v-if="showBoard" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-md p-4" @click.self="showBoard=false">
            <div class="bg-gray-800 rounded-2xl w-full max-w-md border border-gray-600 shadow-2xl transform transition-all flex flex-col max-h-[85vh]">
                <div class="p-6 border-b border-gray-700 bg-gray-800 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
                    <div>
                        <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-500 flex items-center gap-2">ğŸ† è£è€€æ¦œå•</h2>
                        <p class="text-gray-400 text-sm mt-1" v-if="boardGameName">{{ boardGameName }} Top 10</p>
                    </div>
                    <button @click="showBoard=false" class="text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center transition">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto flex-grow custom-scrollbar">
                    <div v-if="board.length === 0" class="text-gray-400 py-12 text-center bg-gray-700/30 rounded-xl border border-gray-700 border-dashed">
                        <div class="text-4xl mb-2">ğŸ”ï¸</div>
                        <p>è™šä½ä»¥å¾…ï¼Œå¿«æ¥æŠ¢å ç¬¬ä¸€åï¼</p>
                    </div>
                    <div class="space-y-2">
                        <div v-for="(s, i) in board" :key="i" class="flex justify-between items-center p-3 rounded-xl transition-all hover:bg-gray-700/70 group"
                             :class="{ 'bg-gradient-to-r from-yellow-500/20 to-transparent border border-yellow-500/30': i===0, 'bg-gradient-to-r from-gray-400/20 to-transparent border border-gray-400/30': i===1, 'bg-gradient-to-r from-orange-500/20 to-transparent border border-orange-500/30': i===2, 'bg-gray-700/30 border border-transparent': i>2, 'ring-2 ring-blue-500 ring-offset-2 ring-offset-gray-800': isCurrentUser(s.player_name) }">
                            <div class="flex items-center gap-3">
                                <div class="w-8 flex justify-center flex-shrink-0">
                                    <span v-if="i===0" class="text-2xl drop-shadow-md">ğŸ¥‡</span>
                                    <span v-else-if="i===1" class="text-2xl drop-shadow-md">ğŸ¥ˆ</span>
                                    <span v-else-if="i===2" class="text-2xl drop-shadow-md">ğŸ¥‰</span>
                                    <span v-else class="font-bold text-gray-500 text-lg w-6 h-6 flex items-center justify-center bg-gray-700 rounded-full text-sm">{{i+1}}</span>
                                </div>
                                <img :src="s.avatar_url || '/static/avatars/default.png'" class="w-10 h-10 rounded-full border-2 border-gray-600 object-cover shadow-sm">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-100 group-hover:text-white transition" :class="{'text-yellow-300': i===0}">{{s.player_name}}</span>
                                    <span v-if="isCurrentUser(s.player_name)" class="text-xs text-blue-400 font-semibold uppercase tracking-wider">æˆ‘</span>
                                </div>
                            </div>
                            <span class="font-mono font-bold text-xl" :class="{ 'text-yellow-400': i===0, 'text-gray-300': i===1, 'text-orange-400': i===2, 'text-blue-400': i>2 }">{{ s.score.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡† -->
        <div v-if="showProfileModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-md p-4" @click.self="showProfileModal=false">
            <div class="bg-gray-800 rounded-2xl w-full max-w-md border border-gray-600 shadow-2xl overflow-hidden">
                <div class="p-6 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-white">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</h2>
                    <button @click="showProfileModal=false" class="text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center transition">&times;</button>
                </div>
                
                <div class="p-6">
                    <!-- å¤´åƒåŒºåŸŸ -->
                    <div class="flex flex-col items-center mb-8">
                        <div class="relative group cursor-pointer" @click="$refs.fileInput.click()">
                            <img :src="user.avatar" class="w-24 h-24 rounded-full border-4 border-gray-600 object-cover shadow-lg group-hover:border-blue-500 transition-colors">
                            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-white text-sm font-bold">æ›´æ¢å¤´åƒ</span>
                            </div>
                        </div>
                        <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="uploadAvatar">
                        <h3 class="text-xl font-bold mt-4">{{ user.username }}</h3>
                    </div>

                    <!-- æˆ˜ç»©åˆ—è¡¨ -->
                    <h4 class="text-gray-400 uppercase text-xs font-bold tracking-wider mb-4 border-b border-gray-700 pb-2">æˆ‘çš„æœ€ä½³æˆ˜ç»©</h4>
                    <div class="space-y-3 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar">
                        <div v-if="userStats.length === 0" class="text-center text-gray-500 py-4">
                            æš‚æ— æˆ˜ç»©ï¼Œå¿«å»ç©æ¸¸æˆå§ï¼
                        </div>
                        <div v-for="stat in userStats" :key="stat.game_key" class="flex justify-between items-center bg-gray-700/30 p-3 rounded-lg border border-gray-700">
                            <span class="font-medium text-gray-300">{{ stat.game_name }}</span>
                            <span class="font-mono font-bold text-blue-400">{{ stat.best_score.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue;
        createApp({
            setup() {
                const user = ref(JSON.parse(localStorage.getItem('user')));
                const games = ref([]);
                const board = ref([]);
                const boardGameName = ref('');
                const showBoard = ref(false);
                const auth = ref({username: '', password: ''});
                const currentGame = ref(null);
                const showAd = ref(false);
                const adCountdown = ref(5);
                const gameIframe = ref(null); 
                const isExiting = ref(false); 
                let adTimer = null;

                const instructions = {
                    'tetris': 'â¬…ï¸ â¡ï¸ ç§»åŠ¨ï¼ŒQ/W æ—‹è½¬ï¼Œâ¬‡ï¸ åŠ é€Ÿ', 
                    'pong': 'ğŸ–±ï¸ ä¸Šä¸‹ç§»åŠ¨é¼ æ ‡æ§åˆ¶æŒ¡æ¿',
                    'breakout': 'â¬…ï¸ â¡ï¸ æ–¹å‘é”®æˆ–é¼ æ ‡ç§»åŠ¨æŒ¡æ¿',
                    '2048': 'â¬†ï¸ â¬‡ï¸ â¬…ï¸ â¡ï¸ æ–¹å‘é”®ç§»åŠ¨æ–¹å—',
                    'flappy': 'ğŸ–±ï¸ ç‚¹å‡»é¼ æ ‡æˆ–å±å¹•è·³è·ƒ',
                    'snake': 'â¬†ï¸ â¬‡ï¸ â¬…ï¸ â¡ï¸ æ–¹å‘é”®æ§åˆ¶ç§»åŠ¨',
                    'raiden': 'â¬…ï¸ â¡ï¸ â¬†ï¸ â¬‡ï¸ ç§»åŠ¨ï¼Œç©ºæ ¼å°„å‡»',
                    'poker': 'é¼ æ ‡ç‚¹å‡» Hit/Stand æŒ‰é’®',
                    'gomoku': 'é¼ æ ‡ç‚¹å‡»æ£‹ç›˜è½å­',
                    'mole': 'é¼ æ ‡ç‚¹å‡»å†’å‡ºçš„åœ°é¼ ',
                    'maze': 'â¬†ï¸ â¬‡ï¸ â¬…ï¸ â¡ï¸ ç§»åŠ¨è“è‰²æ–¹å—åˆ°çº¢è‰²ç»ˆç‚¹',
                    'tank': 'æ–¹å‘é”®ç§»åŠ¨ï¼Œç©ºæ ¼å°„å‡»'
                };

                const handleAuth = async (type) => {
                    if (!auth.value.username || !auth.value.password) return alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
                    try {
                        const res = await fetch(`/api/${type}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(auth.value)
                        });
                        const data = await res.json();
                        if(res.ok) {
                            if(type === 'login') {
                                user.value = data;
                                localStorage.setItem('user', JSON.stringify(data));
                            } else {
                                alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                                auth.value.password = ''; 
                            }
                        } else alert(data.detail || "æ“ä½œå¤±è´¥");
                    } catch (e) {
                        alert("ç½‘ç»œé”™è¯¯");
                    }
                };

                const fetchLeaderboard = async (gameId) => {
                    try {
                        const game = games.value.find(g => g.id === gameId);
                        boardGameName.value = game ? game.name : '';
                        const res = await fetch(`/api/scores/${gameId}`);
                        board.value = await res.json();
                        showBoard.value = true;
                    } catch (e) { console.error(e); }
                };
                
                const isCurrentUser = (name) => user.value && user.value.username === name;
                const logout = () => { user.value = null; localStorage.removeItem('user'); };
                const getInstructions = (id) => instructions[id] || 'ç¥ä½ å¥½è¿ï¼';

                const openGame = (game) => {
                    if (!user.value) return alert("è¯·å…ˆç™»å½•åå†å¼€å§‹æ¸¸æˆï¼");
                    currentGame.value = game;
                    showAd.value = true;
                    isExiting.value = false;
                    adCountdown.value = 5; 
                    if (adTimer) clearInterval(adTimer);
                    adTimer = setInterval(() => {
                        adCountdown.value--;
                        if (adCountdown.value <= 0) {
                            clearInterval(adTimer);
                            showAd.value = false; 
                            setTimeout(() => {
                                if(gameIframe.value) gameIframe.value.contentWindow.focus();
                            }, 100);
                        }
                    }, 1000);
                };

                const performClose = () => {
                    currentGame.value = null;
                    showAd.value = false;
                    isExiting.value = false;
                    if (adTimer) clearInterval(adTimer);
                };

                const closeGame = () => {
                    if(showAd.value) { 
                        performClose();
                        return;
                    }
                    isExiting.value = true;
                    if(gameIframe.value && gameIframe.value.contentWindow) {
                        gameIframe.value.contentWindow.postMessage('submit_and_exit', '*');
                        setTimeout(() => {
                            if(isExiting.value) performClose();
                        }, 2000);
                    } else {
                        performClose();
                    }
                };

                const messageHandler = (e) => {
                    if(e.data === 'score_submitted') {
                        performClose();
                    }
                };
                
                window.addEventListener('message', messageHandler);

                const getGameUrl = (game) => {
                    if (!game || !user.value) return '';
                    const separator = game.url.includes('?') ? '&' : '?';
                    return `${game.url}${separator}uid=${user.value.id}&gkey=${game.id}`;
                };

                const showProfileModal = ref(false);
                const userStats = ref([]);
                const fileInput = ref(null);

                const openProfile = async () => {
                    if(!user.value) return;
                    showProfileModal.value = true;
                    try {
                        const res = await fetch(`/api/user/stats/${user.value.id}`);
                        userStats.value = await res.json();
                    } catch (e) { console.error(e); }
                };

                const uploadAvatar = async (event) => {
                    const file = event.target.files[0];
                    if(!file) return;
                    const formData = new FormData();
                    formData.append('user_id', user.value.id);
                    formData.append('file', file);
                    try {
                        const res = await fetch('/api/user/avatar', { method: 'POST', body: formData });
                        const data = await res.json();
                        if(res.ok) {
                            user.value.avatar = data.avatar_url;
                            localStorage.setItem('user', JSON.stringify(user.value));
                            alert("å¤´åƒæ›´æ–°æˆåŠŸ");
                        } else { alert("ä¸Šä¼ å¤±è´¥: " + data.detail); }
                    } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
                };

                onMounted(async () => {
                    try {
                        const res = await fetch('/api/games');
                        games.value = await res.json();
                    } catch (e) { console.error("æ— æ³•åŠ è½½æ¸¸æˆåˆ—è¡¨", e); }
                });

                return { 
                    user, games, board, showBoard, boardGameName, auth, 
                    currentGame, showAd, adCountdown, getInstructions, isExiting, gameIframe,
                    handleAuth, fetchLeaderboard, logout, openGame, closeGame, getGameUrl, isCurrentUser,
                    showProfileModal, userStats, openProfile, uploadAvatar, fileInput
                }
            }
        }).mount('#app')
    </script>
</body>
</html>