<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Mini-Game HUB</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .game-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .ad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div id="app" class="container mx-auto px-4 py-8 relative">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="flex justify-between items-center mb-8 p-4 bg-gray-800 rounded-xl shadow-lg">
            <div class="text-2xl font-bold text-blue-500">ğŸ® GameHub</div>
            <div class="flex items-center space-x-4">
                <div v-if="!user" class="flex space-x-2">
                    <input v-model="auth.username" placeholder="ç”¨æˆ·å" class="bg-gray-700 text-white px-3 py-1.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input v-model="auth.password" type="password" placeholder="å¯†ç " class="bg-gray-700 text-white px-3 py-1.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button @click="handleAuth('login')" class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded-lg transition">ç™»å½•</button>
                    <button @click="handleAuth('register')" class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg transition">æ³¨å†Œ</button>
                </div>
                <div v-else class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <img :src="user.avatar" class="w-8 h-8 rounded-full border border-gray-600">
                        <span class="font-medium">{{ user.username }}</span>
                    </div>
                    <button @click="logout" class="text-gray-400 hover:text-red-400 transition">é€€å‡º</button>
                </div>
            </div>
        </nav>

        <!-- æ¸¸æˆåˆ—è¡¨ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div v-for="game in games" :key="game.id" class="bg-gray-800 rounded-2xl overflow-hidden hover:shadow-2xl transition duration-300 border border-gray-700 flex flex-col">
                <div class="p-6 flex-grow">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-5xl">{{ game.icon }}</div>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">{{ game.name }}</h3>
                    <p class="text-gray-400 text-sm leading-relaxed mb-6">{{ game.desc }}</p>
                </div>
                <div class="p-6 pt-0 mt-auto grid grid-cols-2 gap-4">
                    <button @click="openGame(game)" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg">
                        â–¶ å¼€å§‹ç©
                    </button>
                    <button @click="fetchLeaderboard(game.id)" class="bg-gray-700 hover:bg-gray-600 text-blue-400 font-bold py-3 rounded-xl transition">
                        ğŸ† æ’è¡Œæ¦œ
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆæ¨¡æ€æ¡† (åŒ…å«å¹¿å‘Šå±‚) -->
        <div v-if="currentGame" class="fixed inset-0 bg-black z-50 flex flex-col">
            <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
            <div class="bg-gray-900 p-4 flex justify-between items-center border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">{{ currentGame.icon }}</span>
                    <h2 class="text-xl font-bold">{{ currentGame.name }}</h2>
                </div>
                <button @click="closeGame" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold transition">
                    é€€å‡ºæ¸¸æˆ
                </button>
            </div>

            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div class="flex-grow relative bg-gray-900">
                <!-- å¹¿å‘Šé®ç½©å±‚ -->
                <div v-if="showAd" class="ad-overlay">
                    <div class="bg-white text-gray-900 p-8 rounded-2xl max-w-md text-center shadow-2xl">
                        <h3 class="text-2xl font-bold mb-4">âœ¨ ç²¾å½©æ¨è âœ¨</h3>
                        <p class="text-gray-600 mb-6">è¿™é‡Œæ˜¯å¹¿å‘Šä½ã€‚å±•ç¤ºé«˜å“è´¨æ¸¸æˆå¤–è®¾ã€æœ€æ–°æ¸¸æˆå¤§ä½œé¢„å‘Šç­‰ã€‚</p>
                        <div class="text-6xl mb-6">ğŸ®</div>
                        <button class="bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-full cursor-not-allowed" disabled>
                            å¹¿å‘Šå‰©ä½™ {{ adCountdown }} ç§’
                        </button>
                    </div>
                </div>

                <!-- æ¸¸æˆ Iframe -->
                <!-- æ³¨æ„ï¼šæˆ‘ä»¬å°† user_id ä½œä¸ºå‚æ•°ä¼ é€’ç»™ iframeï¼Œä»¥ä¾¿æ¸¸æˆå†…éƒ¨çŸ¥é“æ˜¯è°åœ¨ç© -->
                <iframe 
                    v-show="!showAd"
                    :src="getGameUrl(currentGame)" 
                    class="game-iframe"
                    title="Game Window"
                ></iframe>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œå¼¹çª— -->
        <div v-if="showBoard" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-gray-800 p-8 rounded-2xl w-96 border border-gray-600 shadow-2xl transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400">ğŸ† è£è€€æ¦œå•</h2>
                    <button @click="showBoard=false" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                
                <div v-if="board.length === 0" class="text-gray-400 py-8 text-center bg-gray-700/50 rounded-lg">
                    æš‚æ— æ•°æ®ï¼Œå¿«æ¥æŠ¢å ç¬¬ä¸€åï¼
                </div>
                
                <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <div v-for="(s, i) in board" :key="i" 
                         class="flex justify-between items-center p-3 rounded-lg"
                         :class="{'bg-yellow-500/20 border border-yellow-500/30': i===0, 'bg-gray-700/50': i>0}">
                        <div class="flex items-center">
                            <span class="w-8 font-bold text-lg" :class="{'text-yellow-400': i===0, 'text-gray-400': i>0}">#{{i+1}}</span>
                            <img :src="s.avatar_url || '/static/avatars/default.png'" class="w-8 h-8 rounded-full mr-3 border border-gray-600">
                            <span class="font-medium text-gray-200">{{s.player_name}}</span>
                        </div>
                        <span class="font-mono font-bold text-blue-400">{{s.score}}</span>
                    </div>
                </div>
                
                <button @click="showBoard=false" class="w-full mt-6 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold transition">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const user = ref(JSON.parse(localStorage.getItem('user')));
                const games = ref([]);
                const board = ref([]);
                const showBoard = ref(false);
                const auth = ref({username: '', password: ''});

                // æ–°å¢çŠ¶æ€
                const currentGame = ref(null);
                const showAd = ref(false);
                const adCountdown = ref(5);
                let adTimer = null;

                const handleAuth = async (type) => {
                    if (!auth.value.username || !auth.value.password) return alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
                    try {
                        const res = await fetch(`/api/${type}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(auth.value)
                        });
                        const data = await res.json();
                        if(res.ok) {
                            if(type === 'login') {
                                user.value = data;
                                localStorage.setItem('user', JSON.stringify(data));
                            } else {
                                alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                                auth.value.password = ''; // æ¸…ç©ºå¯†ç æ–¹ä¾¿ç™»å½•
                            }
                        } else alert(data.detail || "æ“ä½œå¤±è´¥");
                    } catch (e) {
                        alert("ç½‘ç»œé”™è¯¯");
                    }
                };

                const fetchLeaderboard = async (id) => {
                    try {
                        const res = await fetch(`/api/scores/${id}`);
                        board.value = await res.json();
                        showBoard.value = true;
                    } catch (e) {
                        console.error(e);
                    }
                };

                const logout = () => { 
                    user.value = null; 
                    localStorage.removeItem('user'); 
                };

                // æ‰“å¼€æ¸¸æˆå¹¶æ˜¾ç¤ºå¹¿å‘Š
                const openGame = (game) => {
                    if (!user.value) {
                        alert("è¯·å…ˆç™»å½•åå†å¼€å§‹æ¸¸æˆï¼");
                        return;
                    }
                    currentGame.value = game;
                    showAd.value = true;
                    adCountdown.value = 5; // å¹¿å‘Šæ—¶é•¿ 5 ç§’

                    // å¯åŠ¨å€’è®¡æ—¶
                    if (adTimer) clearInterval(adTimer);
                    adTimer = setInterval(() => {
                        adCountdown.value--;
                        if (adCountdown.value <= 0) {
                            clearInterval(adTimer);
                            showAd.value = false; // å¹¿å‘Šç»“æŸï¼Œæ˜¾ç¤ºæ¸¸æˆ
                        }
                    }, 1000);
                };

                // å…³é—­æ¸¸æˆ
                const closeGame = () => {
                    currentGame.value = null;
                    showAd.value = false;
                    if (adTimer) clearInterval(adTimer);
                    // åˆ·æ–°é¡µé¢æˆ–é‡æ–°åŠ è½½æ•°æ®å¯èƒ½ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å¯ä»¥æ¸…ç©ºä¸€äº›çŠ¶æ€
                };

                // ç”Ÿæˆå¸¦æœ‰ç”¨æˆ·IDçš„æ¸¸æˆURLï¼Œä»¥ä¾¿æ¸¸æˆå†…éƒ¨ä½¿ç”¨
                const getGameUrl = (game) => {
                    if (!game || !user.value) return '';
                    // å‡è®¾æ¸¸æˆ URL å¯èƒ½æ˜¯ /static/games/snake/index.html
                    // æˆ‘ä»¬é™„åŠ  query å‚æ•°
                    const separator = game.url.includes('?') ? '&' : '?';
                    return `${game.url}${separator}uid=${user.value.id}&gkey=${game.id}`;
                };

                onMounted(async () => {
                    try {
                        const res = await fetch('/api/games');
                        games.value = await res.json();
                    } catch (e) {
                        console.error("æ— æ³•åŠ è½½æ¸¸æˆåˆ—è¡¨", e);
                    }
                });

                return { 
                    user, games, board, showBoard, auth, 
                    currentGame, showAd, adCountdown,
                    handleAuth, fetchLeaderboard, logout, openGame, closeGame, getGameUrl 
                }
            }
        }).mount('#app')
    </script>
</body>
</html>